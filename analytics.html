<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Analytics | Statistiques</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Librairie Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    :root {
      --primary: #4e54c8;
      --secondary: #8f94fb;
      --glass-bg: rgba(255, 255, 255, 0.65);
      --glass-border: rgba(255, 255, 255, 0.5);
      --text-dark: #2d3436;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }

    body {
      background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%);
      min-height: 100vh;
      display: flex;
      overflow-x: hidden;
      color: var(--text-dark);
    }

    /* --- SIDEBAR --- */
    .sidebar {
      width: 250px;
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(10px);
      height: 100vh;
      position: fixed;
      left: 0; top: 0;
      padding: 20px;
      border-right: 1px solid var(--glass-border);
      display: flex; flex-direction: column;
      z-index: 100;
    }

    .logo {
      font-size: 1.5rem; font-weight: 700; color: var(--primary);
      margin-bottom: 40px; display: flex; align-items: center; gap: 10px;
    }

    .nav-links { list-style: none; flex: 1; }
    .nav-links li { margin-bottom: 15px; }
    
    .nav-links a {
      text-decoration: none; color: var(--text-dark); font-weight: 500;
      display: flex; align-items: center; gap: 15px; padding: 12px;
      border-radius: 10px; transition: all 0.3s;
    }

    .nav-links a:hover, .nav-links a.active {
      background: var(--primary); color: white;
      box-shadow: 0 5px 15px rgba(78, 84, 200, 0.3);
    }

    /* --- MAIN CONTENT --- */
    .main-content {
      margin-left: 250px; flex: 1; padding: 30px;
    }

    header { margin-bottom: 30px; }
    header h1 { font-size: 1.8rem; margin-bottom: 5px; }
    header p { color: #666; font-size: 0.9rem; }

    /* --- GRILLE DES GRAPHIQUES --- */
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr); /* 2 colonnes */
      gap: 25px;
    }

    .chart-card {
      background: var(--glass-bg);
      backdrop-filter: blur(15px);
      border: 1px solid var(--glass-border);
      border-radius: 20px;
      padding: 25px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.05);
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .full-width { grid-column: 1 / -1; width: 100%; }

    .chart-header {
      width: 100%;
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 20px;
    }

    .chart-header h3 { font-size: 1.1rem; color: var(--primary); }

    /* Conteneur Canvas pour le responsive */
    .canvas-container {
      position: relative;
      height: 300px;
      width: 100%;
      display: flex;
      justify-content: center;
    }

    /* Responsive mobile */
    @media (max-width: 768px) {
      .sidebar { display: none; }
      .main-content { margin-left: 0; }
      .charts-grid { grid-template-columns: 1fr; }
    }

  </style>
</head>
<body>

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="logo">
      <i class="fa-solid fa-layer-group"></i> WorkSpace
    </div>
    <ul class="nav-links">
      <li><a href="PLATEFORMECOLLAB.html"><i class="fa-solid fa-house"></i> Vue d'ensemble</a></li>
      <li><a href="dashboard.html"><i class="fa-solid fa-chart-line"></i> Tableau de Bord</a></li>
      <li><a href="#" class="active"><i class="fa-solid fa-chart-pie"></i> Analytics</a></li>
    </ul>
    
    <div style="margin-top: auto;">
      <button onclick="window.location.href='login.html'" style="width:100%; padding:10px; background:#ff7675; color:white; border:none; border-radius:8px; cursor:pointer;">
        <i class="fa-solid fa-power-off"></i> Déconnexion
      </button>
    </div>
  </aside>

  <!-- MAIN CONTENT -->
  <main class="main-content">
    <header>
      <h1>Analyses & Statistiques</h1>
      <p>Visualisez la performance de vos équipes et l'avancement des projets.</p>
    </header>

    <div class="charts-grid">
      
      <!-- GRAPHIQUE 1 : Progression par Projet (Barres) -->
      <div class="chart-card full-width">
        <div class="chart-header">
          <h3><i class="fa-solid fa-bars-progress"></i> Avancement par Projet (%)</h3>
        </div>
        <div class="canvas-container">
          <canvas id="projectProgressChart"></canvas>
        </div>
      </div>

      <!-- GRAPHIQUE 2 : Répartition Globale (Donut) -->
      <div class="chart-card">
        <div class="chart-header">
          <h3><i class="fa-solid fa-circle-notch"></i> État des Tâches</h3>
        </div>
        <div class="canvas-container">
          <canvas id="globalStatusChart"></canvas>
        </div>
      </div>

      <!-- GRAPHIQUE 3 : Volume par Équipe (Polar Area) -->
      <div class="chart-card">
        <div class="chart-header">
          <h3><i class="fa-solid fa-users-viewfinder"></i> Volume par Équipe</h3>
        </div>
        <div class="canvas-container">
          <canvas id="teamPerformanceChart"></canvas>
        </div>
      </div>

    </div>
  </main>

  <script>
    // ==============================
    // 1. CHARGEMENT DES DONNÉES
    // ==============================
    const projects = JSON.parse(localStorage.getItem("projects")) || [];
    const tasks = JSON.parse(localStorage.getItem("tasks")) || [];
    const teams = JSON.parse(localStorage.getItem("teams")) || [];

    // Configuration globale des polices Chart.js
    Chart.defaults.font.family = "'Poppins', sans-serif";
    Chart.defaults.color = '#555';

    // ==============================
    // 2. PRÉPARATION DES DONNÉES
    // ==============================

    // A. Progression par Projet
    const projectLabels = projects;
    const projectData = projects.map(p => {
      const pTasks = tasks.filter(t => t.project === p);
      if(pTasks.length === 0) return 0;
      const done = pTasks.filter(t => t.completed).length;
      return Math.round((done / pTasks.length) * 100);
    });

    // B. Global Status (Terminé vs En cours)
    const completedCount = tasks.filter(t => t.completed).length;
    const pendingCount = tasks.length - completedCount;

    // C. Tâches par Équipe (Filtrage)
    const teamLabels = teams;
    const teamData = teams.map(t => {
      // Compte le nombre de tâches assignées à chaque équipe
      return tasks.filter(task => task.team === t).length;
    });

    // ==============================
    // 3. CRÉATION DES GRAPHIQUES
    // ==============================

    // --- CHART 1: BARRES VERTICALES (Projets) ---
    const ctx1 = document.getElementById('projectProgressChart');
    new Chart(ctx1, {
      type: 'bar',
      data: {
        labels: projectLabels.length > 0 ? projectLabels : ['Aucun projet'],
        datasets: [{
          label: 'Progression (%)',
          data: projectData.length > 0 ? projectData : [0],
          backgroundColor: 'rgba(78, 84, 200, 0.6)',
          borderColor: 'rgba(78, 84, 200, 1)',
          borderWidth: 1,
          borderRadius: 5
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: { beginAtZero: true, max: 100 }
        }
      }
    });

    // --- CHART 2: DONUT (Global Status) ---
    const ctx2 = document.getElementById('globalStatusChart');
    new Chart(ctx2, {
      type: 'doughnut',
      data: {
        labels: ['Terminées', 'En cours'],
        datasets: [{
          data: [completedCount, pendingCount],
          backgroundColor: ['#00b894', '#fdcb6e'], // Vert et Jaune
          borderWidth: 2,
          borderColor: '#ffffff'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: 'bottom' }
        }
      }
    });

    // --- CHART 3: POLAR AREA (Équipes) ---
    const ctx3 = document.getElementById('teamPerformanceChart');
    new Chart(ctx3, {
      type: 'polarArea',
      data: {
        labels: teamLabels.length > 0 ? teamLabels : ['Aucune équipe'],
        datasets: [{
          label: 'Nombre de tâches',
          data: teamData.length > 0 ? teamData : [0],
          backgroundColor: [
            'rgba(255, 118, 117, 0.6)', // Rouge pastel
            'rgba(116, 185, 255, 0.6)', // Bleu pastel
            'rgba(85, 239, 196, 0.6)',  // Vert pastel
            'rgba(162, 155, 254, 0.6)', // Violet pastel
            'rgba(253, 203, 110, 0.6)'  // Jaune pastel
          ],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: 'bottom' }
        }
      }
    });

  </script>
</body>
</html>